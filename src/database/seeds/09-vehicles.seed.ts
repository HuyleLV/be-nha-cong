import { DataSource } from 'typeorm';
import { Vehicle } from '../../modules/vehicles/entities/vehicle.entity';
import { Building } from '../../modules/building/entities/building.entity';
import { User } from '../../modules/users/entities/user.entity';
import { ensureUniqueSlug } from '../../common/helpers/slug.helper';

/**
 * Vehicles Seeding
 * Creates sample vehicles (cars and motorbikes) for buildings
 */
export async function seedVehicles(
  dataSource: DataSource,
  buildings: Building[],
  host?: User,
) {
  console.log('üöó Seeding vehicles...');

  const vehicleRepository = dataSource.getRepository(Vehicle);
  const buildingRepository = dataSource.getRepository(Building);

  // Get buildings if not provided
  let buildingList = buildings;
  if (!buildingList || buildingList.length === 0) {
    buildingList = await buildingRepository.find({ take: 5 });
  }

  if (buildingList.length === 0) {
    console.log('‚ö†Ô∏è  No buildings found, skipping vehicles...');
    return [];
  }

  const vehiclesData = [
    // Cars - For rent
    {
      type: 'oto',
      model: 'Toyota Vios',
      color: 'Tr·∫Øng',
      plateNumber: '30A-12345',
      ownerName: 'Nguy·ªÖn VƒÉn An',
      ticketNumber: 'T001',
      buildingId: buildingList[0]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '800000',
      pricePerHour: '100000',
      status: 'available',
      description:
        'Xe Toyota Vios 2022, m√†u tr·∫Øng, ƒë·∫ßy ƒë·ªß ti·ªán √≠ch. Ph√π h·ª£p cho gia ƒë√¨nh, ƒëi du l·ªãch.',
      features: ['GPS', 'Bluetooth', 'Camera l√πi', 'ƒêi·ªÅu h√≤a'],
      seats: 5,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2022,
      createdBy: host?.id || null,
    },
    {
      type: 'oto',
      model: 'Honda City',
      color: 'ƒêen',
      plateNumber: '29B-67890',
      ownerName: 'Tr·∫ßn Th·ªã B√¨nh',
      ticketNumber: 'T002',
      buildingId: buildingList[0]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'co_lai',
      hasDriver: true,
      pricePerDay: '1200000',
      pricePerHour: '150000',
      status: 'available',
      description:
        'Xe Honda City 2023, c√≥ t√†i x·∫ø chuy√™n nghi·ªáp. Ph√π h·ª£p cho c√¥ng t√°c, ƒë∆∞a ƒë√≥n s√¢n bay.',
      features: ['GPS', 'Bluetooth', 'Camera l√πi', 'ƒêi·ªÅu h√≤a', 'C√≥ t√†i x·∫ø'],
      seats: 5,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2023,
      createdBy: host?.id || null,
    },
    {
      type: 'oto',
      model: 'Mazda 3',
      color: 'X√°m',
      plateNumber: '30A-11111',
      ownerName: 'L√™ VƒÉn C∆∞·ªùng',
      ticketNumber: 'T003',
      buildingId: buildingList[1]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '1000000',
      pricePerHour: '120000',
      status: 'available',
      description:
        'Xe Mazda 3 2021, m√†u x√°m, sang tr·ªçng. Ph√π h·ª£p cho c√°c d·ªãp ƒë·∫∑c bi·ªát.',
      features: [
        'GPS',
        'Bluetooth',
        'Camera 360',
        'ƒêi·ªÅu h√≤a t·ª± ƒë·ªông',
        'C·∫£nh b√°o va ch·∫°m',
      ],
      seats: 5,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2021,
      createdBy: host?.id || null,
    },
    {
      type: 'oto',
      model: 'Hyundai Accent',
      color: 'B·∫°c',
      plateNumber: '29B-22222',
      ownerName: 'Ph·∫°m Th·ªã Dung',
      ticketNumber: 'T004',
      buildingId: buildingList[1]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '700000',
      pricePerHour: '90000',
      status: 'rented',
      description: 'Xe Hyundai Accent 2020, ti·∫øt ki·ªám nhi√™n li·ªáu, gi√° r·∫ª.',
      features: ['GPS', 'Bluetooth', 'ƒêi·ªÅu h√≤a'],
      seats: 5,
      fuelType: 'xang',
      transmission: 'so_tay',
      year: 2020,
      createdBy: host?.id || null,
    },
    {
      type: 'oto',
      model: 'Ford Ranger',
      color: 'Xanh d∆∞∆°ng',
      plateNumber: '30A-33333',
      ownerName: 'Ho√†ng VƒÉn Em',
      ticketNumber: 'T005',
      buildingId: buildingList[2]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '1500000',
      pricePerHour: '200000',
      status: 'available',
      description:
        'Xe b√°n t·∫£i Ford Ranger 2022, ph√π h·ª£p cho c√¥ng vi·ªác, ƒëi ph∆∞·ª£t.',
      features: ['GPS', 'Bluetooth', 'Camera l√πi', '4WD', 'G·∫ßm cao'],
      seats: 5,
      fuelType: 'diesel',
      transmission: 'tu_dong',
      year: 2022,
      createdBy: host?.id || null,
    },
    // Motorbikes - For rent
    {
      type: 'xe_may',
      model: 'Honda Wave Alpha',
      color: 'ƒê·ªè',
      plateNumber: '29B1-12345',
      ownerName: 'Nguy·ªÖn Th·ªã Ph∆∞∆°ng',
      ticketNumber: 'XM001',
      buildingId: buildingList[0]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '150000',
      pricePerHour: '25000',
      status: 'available',
      description:
        'Xe m√°y Honda Wave Alpha, ti·∫øt ki·ªám xƒÉng, ph√π h·ª£p ƒëi l·∫°i trong th√†nh ph·ªë.',
      features: ['Ti·∫øt ki·ªám xƒÉng', 'D·ªÖ ƒëi·ªÅu khi·ªÉn'],
      seats: 2,
      fuelType: 'xang',
      transmission: 'so_tay',
      year: 2021,
      createdBy: host?.id || null,
    },
    {
      type: 'xe_may',
      model: 'Yamaha Exciter',
      color: 'Xanh l√°',
      plateNumber: '30A1-67890',
      ownerName: 'Tr·∫ßn VƒÉn Giang',
      ticketNumber: 'XM002',
      buildingId: buildingList[0]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '200000',
      pricePerHour: '30000',
      status: 'available',
      description: 'Xe m√°y Yamaha Exciter 2023, m·∫°nh m·∫Ω, ph√π h·ª£p cho gi·ªõi tr·∫ª.',
      features: ['M·∫°nh m·∫Ω', 'Thi·∫øt k·∫ø th·ªÉ thao'],
      seats: 2,
      fuelType: 'xang',
      transmission: 'so_tay',
      year: 2023,
      createdBy: host?.id || null,
    },
    {
      type: 'xe_may',
      model: 'Honda Vision',
      color: 'Tr·∫Øng',
      plateNumber: '29B1-11111',
      ownerName: 'L√™ Th·ªã Hoa',
      ticketNumber: 'XM003',
      buildingId: buildingList[1]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '180000',
      pricePerHour: '28000',
      status: 'available',
      description: 'Xe m√°y Honda Vision, ti·∫øt ki·ªám xƒÉng, d·ªÖ ƒëi·ªÅu khi·ªÉn.',
      features: ['Ti·∫øt ki·ªám xƒÉng', 'D·ªÖ ƒëi·ªÅu khi·ªÉn'],
      seats: 2,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2022,
      createdBy: host?.id || null,
    },
    {
      type: 'xe_may',
      model: 'SYM Attila',
      color: 'V√†ng',
      plateNumber: '30A1-22222',
      ownerName: 'Ph·∫°m VƒÉn Khoa',
      ticketNumber: 'XM004',
      buildingId: buildingList[1]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: null,
      hasDriver: false,
      pricePerDay: null,
      pricePerHour: null,
      status: 'unavailable',
      description: null,
      features: null,
      seats: 2,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2020,
      createdBy: host?.id || null,
    },
    {
      type: 'xe_may',
      model: 'Piaggio Vespa',
      color: 'H·ªìng',
      plateNumber: '29B1-33333',
      ownerName: 'Ho√†ng Th·ªã Lan',
      ticketNumber: 'XM005',
      buildingId: buildingList[2]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '250000',
      pricePerHour: '40000',
      status: 'available',
      description: 'Xe tay ga Piaggio Vespa, sang tr·ªçng, ph√π h·ª£p ph√°i ƒë·∫πp.',
      features: ['Sang tr·ªçng', 'Thi·∫øt k·∫ø ƒë·∫πp'],
      seats: 2,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2022,
      createdBy: host?.id || null,
    },
    {
      type: 'xe_may',
      model: 'Honda SH',
      color: 'ƒêen',
      plateNumber: '30A1-44444',
      ownerName: 'Nguy·ªÖn VƒÉn Minh',
      ticketNumber: 'XM006',
      buildingId: buildingList[2]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '300000',
      pricePerHour: '50000',
      status: 'available',
      description: 'Xe m√°y Honda SH 2023, cao c·∫•p, ƒë·∫ßy ƒë·ªß ti·ªán √≠ch.',
      features: ['Cao c·∫•p', 'ƒê·∫ßy ƒë·ªß ti·ªán √≠ch', 'Kh·ªüi ƒë·ªông b·∫±ng n√∫t'],
      seats: 2,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2023,
      createdBy: host?.id || null,
    },
    {
      type: 'xe_may',
      model: 'Yamaha Grande',
      color: 'X√°m',
      plateNumber: '29B1-55555',
      ownerName: 'Tr·∫ßn Th·ªã Nga',
      ticketNumber: 'XM007',
      buildingId: buildingList[3]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: null,
      hasDriver: false,
      pricePerDay: null,
      pricePerHour: null,
      status: 'maintenance',
      description: null,
      features: null,
      seats: 2,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2021,
      createdBy: host?.id || null,
    },
    {
      type: 'xe_may',
      model: 'Honda Lead',
      color: 'B·∫°c',
      plateNumber: '30A1-66666',
      ownerName: 'L√™ VƒÉn Oanh',
      ticketNumber: 'XM008',
      buildingId: buildingList[3]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '220000',
      pricePerHour: '35000',
      status: 'available',
      description: 'Xe m√°y Honda Lead, ti·∫øt ki·ªám xƒÉng, b·ªÅn b·ªâ.',
      features: ['Ti·∫øt ki·ªám xƒÉng', 'B·ªÅn b·ªâ'],
      seats: 2,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2022,
      createdBy: host?.id || null,
    },
    {
      type: 'xe_may',
      model: 'SYM Attila ES',
      color: 'Xanh d∆∞∆°ng',
      plateNumber: '29B1-77777',
      ownerName: 'Ph·∫°m Th·ªã Qu·ª≥nh',
      ticketNumber: 'XM009',
      buildingId: buildingList[4]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: null,
      hasDriver: false,
      pricePerDay: null,
      pricePerHour: null,
      status: 'unavailable',
      description: null,
      features: null,
      seats: 2,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2020,
      createdBy: host?.id || null,
    },
    {
      type: 'xe_may',
      model: 'Honda Air Blade',
      color: 'Cam',
      plateNumber: '30A1-88888',
      ownerName: 'Ho√†ng VƒÉn S∆°n',
      ticketNumber: 'XM010',
      buildingId: buildingList[4]?.id,
      apartmentId: null,
      customerId: null,
      photo: null,
      rentalType: 'tu_lai',
      hasDriver: false,
      pricePerDay: '280000',
      pricePerHour: '45000',
      status: 'available',
      description:
        'Xe m√°y Honda Air Blade 2023, m·∫°nh m·∫Ω, ph√π h·ª£p m·ªçi ƒë·ªãa h√¨nh.',
      features: ['M·∫°nh m·∫Ω', 'Ph√π h·ª£p m·ªçi ƒë·ªãa h√¨nh'],
      seats: 2,
      fuelType: 'xang',
      transmission: 'tu_dong',
      year: 2023,
      createdBy: host?.id || null,
    },
  ];

  const vehicles: Vehicle[] = [];

  for (const data of vehiclesData) {
    // Check if vehicle already exists (by plate number)
    const existing = await vehicleRepository.findOne({
      where: { plateNumber: data.plateNumber },
    });

    if (!existing) {
      // Generate slug from model, plateNumber, or type
      const slugBase = data.model || data.plateNumber || `xe-${data.type || 'unknown'}`;
      const slug = await ensureUniqueSlug(vehicleRepository, slugBase);

      const vehicle = vehicleRepository.create({
        ...data,
        slug,
      });
      const saved = await vehicleRepository.save(vehicle);
      vehicles.push(saved);
    } else {
      // Update existing vehicle with slug if missing
      if (!existing.slug) {
        const slugBase = existing.model || existing.plateNumber || `xe-${existing.type || 'unknown'}`;
        existing.slug = await ensureUniqueSlug(vehicleRepository, slugBase, existing.id);
        await vehicleRepository.save(existing);
      }
      vehicles.push(existing);
    }
  }

  console.log(
    `‚úÖ Created ${vehicles.length} vehicles (${vehiclesData.length} total)`,
  );
  return vehicles;
}
